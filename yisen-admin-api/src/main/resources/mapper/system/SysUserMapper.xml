<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yisen.module.system.user.mapper.SysUserMapper">

    <resultMap id="BaseResultMap" type="com.yisen.module.system.user.model.po.SysUser">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="realName" column="real_name"/>
        <result property="gender" column="gender"/>
        <result property="avatar" column="avatar"/>
        <result property="email" column="email"/>
        <result property="departId" column="depart_id"/>
        <result property="loginIp" column="login_ip"/>
        <result property="loginTime" column="login_time"/>
        <result property="status" column="status"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="Base_Column_List">
        id
        ,username,password,real_name,gender,avatar,
        email,departId,login_ip,login_time,status,is_deleted,
        create_by,create_time,update_by,update_time
    </sql>

    <!-- 用户详情 ResultMap（包含角色信息） -->
    <resultMap id="UserDetailResultMap" type="com.yisen.module.system.user.model.vo.UserDetailVO">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="realName" column="real_name"/>
        <result property="gender" column="gender"/>
        <result property="avatar" column="avatar"/>
        <result property="email" column="email"/>
        <result property="departId" column="depart_id"/>
        <result property="loginIp" column="login_ip"/>
        <result property="loginTime" column="login_time"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <!-- 角色信息集合映射 -->
        <collection property="roles" ofType="com.yisen.module.system.user.model.vo.UserDetailVO$RoleVO">
            <id property="id" column="role_id"/>
            <result property="roleName" column="role_name"/>
            <result property="roleCode" column="role_code"/>
        </collection>
    </resultMap>

    <!-- 分页查询用户列表（包含角色信息） -->
    <select id="selectUserPageWithRoles" resultMap="UserDetailResultMap">
        SELECT DISTINCT
        u.id,
        u.username,
        u.real_name,
        u.gender,
        u.avatar,
        u.email,
        u.depart_id,
        u.login_ip,
        u.login_time,
        u.status,
        u.create_by,
        u.create_time,
        u.update_by,
        u.update_time,
        r.id as role_id,
        r.role_name,
        r.role_code
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id AND r.is_deleted = 0
        WHERE u.is_deleted = 0
        <if test="query != null">
            <if test="query.username != null and query.username != ''">
                AND u.username LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.realName != null and query.realName != ''">
                AND u.real_name LIKE CONCAT('%', #{query.realName}, '%')
            </if>
            <if test="query.email != null and query.email != ''">
                AND u.email LIKE CONCAT('%', #{query.email}, '%')
            </if>
            <if test="query.departId != null and query.departId != ''">
                AND u.depart_id = #{query.departId}
            </if>
            <if test="query.gender != null">
                AND u.gender = #{query.gender}
            </if>
            <if test="query.status != null">
                AND u.status = #{query.status}
            </if>
            <if test="query.createTimeStart != null and query.createTimeStart != ''">
                AND u.create_time &gt;= #{query.createTimeStart}
            </if>
            <if test="query.createTimeEnd != null and query.createTimeEnd != ''">
                AND u.create_time &lt;= #{query.createTimeEnd}
            </if>
        </if>
        ORDER BY u.create_time DESC
    </select>

    <!-- 根据ID查询用户详情（包含角色信息） -->
    <select id="selectUserDetailById" resultMap="UserDetailResultMap">
        SELECT u.id,
               u.username,
               u.real_name,
               u.gender,
               u.avatar,
               u.email,
               u.depart_id,
               u.login_ip,
               u.login_time,
               u.status,
               u.create_by,
               u.create_time,
               u.update_by,
               u.update_time,
               r.id as role_id,
               r.role_name,
               r.role_code
        FROM sys_user u
                 LEFT JOIN sys_user_role ur ON u.id = ur.user_id
                 LEFT JOIN sys_role r ON ur.role_id = r.id AND r.is_deleted = 0
        WHERE u.id = #{id}
          AND u.is_deleted = 0
    </select>

    <!-- 批量查询用户列表（包含角色信息） -->
    <select id="selectUserListWithRoles" resultMap="UserDetailResultMap">
        SELECT
        u.id,
        u.username,
        u.real_name,
        u.gender,
        u.avatar,
        u.email,
        u.depart_id,
        u.login_ip,
        u.login_time,
        u.status,
        u.create_by,
        u.create_time,
        u.update_by,
        u.update_time,
        r.id as role_id,
        r.role_name,
        r.role_code
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id AND r.is_deleted = 0
        WHERE u.id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        AND u.is_deleted = 0
        ORDER BY u.create_time DESC
    </select>

    <!-- 查询用户的角色编码集合 -->
    <select id="selectRoleCodesByUserId" resultType="java.lang.String">
        SELECT DISTINCT r.role_code
        FROM sys_role r
                 INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND r.is_deleted = 0
          AND r.status = 1
    </select>

    <!-- 查询用户的权限标识集合（通过角色-菜单关联） -->
    <select id="selectPermissionsByUserId" resultType="java.lang.String">
        SELECT DISTINCT m.permission
        FROM sys_menu m
                 INNER JOIN sys_role_menu rm ON m.id = rm.menu_id
                 INNER JOIN sys_role r ON rm.role_id = r.id AND r.is_deleted = 0 AND r.status = 1
                 INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND m.is_deleted = 0
          AND m.status = 1
          AND m.permission IS NOT NULL
          AND m.permission != ''
    </select>

</mapper>
