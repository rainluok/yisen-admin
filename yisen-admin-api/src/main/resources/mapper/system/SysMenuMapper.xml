<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yisen.module.system.menu.mapper.SysMenuMapper">

    <resultMap id="BaseResultMap" type="com.yisen.module.system.menu.model.po.SysMenu">
            <id property="id" column="id" />
            <result property="parentId" column="parent_id" />
            <result property="menuName" column="menu_name" />
            <result property="menuCode" column="menu_code" />
            <result property="type" column="type" />
            <result property="path" column="path" />
            <result property="component" column="component" />
            <result property="permission" column="permission" />
            <result property="icon" column="icon" />
            <result property="hidden" column="hidden" />
            <result property="layout" column="layout" />
            <result property="sort" column="sort" />
            <result property="status" column="status" />
            <result property="isDeleted" column="is_deleted" />
            <result property="createBy" column="create_by" />
            <result property="createTime" column="create_time" />
            <result property="updateBy" column="update_by" />
            <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id,parent_id,menu_name,menu_code,type,path,
        component,permission,icon,hidden,layout,
        sort,status,is_deleted,create_by,create_time,
        update_by,update_time
    </sql>

    <!-- 菜单树 ResultMap -->
    <resultMap id="MenuTreeResultMap" type="com.yisen.module.system.menu.model.vo.MenuTreeVO">
        <id property="id" column="id"/>
        <result property="parentId" column="parent_id"/>
        <result property="menuName" column="menu_name"/>
        <result property="menuCode" column="menu_code"/>
        <result property="type" column="type"/>
        <result property="path" column="path"/>
        <result property="component" column="component"/>
        <result property="permission" column="permission"/>
        <result property="icon" column="icon"/>
        <result property="hidden" column="hidden"/>
        <result property="layout" column="layout"/>
        <result property="sort" column="sort"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 查询用户可用菜单列表（根据用户ID，通过用户-角色-菜单关联） -->
    <select id="selectMenuListByUserId" resultMap="MenuTreeResultMap">
        SELECT DISTINCT
            m.id,
            m.parent_id,
            m.menu_name,
            m.menu_code,
            m.type,
            m.path,
            m.component,
            m.permission,
            m.icon,
            m.hidden,
            m.layout,
            m.sort,
            m.status,
            m.create_time
        FROM sys_menu m
        INNER JOIN sys_role_menu rm ON m.id = rm.menu_id
        INNER JOIN sys_role r ON rm.role_id = r.id AND r.is_deleted = 0 AND r.status = 1
        INNER JOIN sys_user_role ur ON r.id = ur.role_id
        INNER JOIN sys_user u ON ur.user_id = u.id AND u.is_deleted = 0 AND u.status = 1
        WHERE u.id = #{userId}
          AND m.is_deleted = 0
          AND m.status = 1
        ORDER BY m.sort ASC, m.create_time ASC
    </select>

    <!-- 查询所有菜单列表 -->
    <select id="selectAllMenuList" resultMap="MenuTreeResultMap">
        SELECT
            id,
            parent_id,
            menu_name,
            menu_code,
            type,
            path,
            component,
            permission,
            icon,
            hidden,
            layout,
            sort,
            status,
            create_time
        FROM sys_menu
        WHERE is_deleted = 0
        ORDER BY sort ASC, create_time ASC
    </select>

</mapper>
